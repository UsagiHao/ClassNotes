## chapter8 存储与索引概述
本章使用的示例：一个雇员记录的文件，每一条记录包含字段age，name和sal。  
在DBMS中，基本的数据抽象是一个记录的集合，或一个文件，并且每一个文件由一个或多个页构成。文件及访问方法层巧妙的组织数据以支持对所要子集或记录的快速访问。为了有效地使用数据库系统，理解记录的组织是非常基本的事情，这是本章的主题。
### 8.1 外部存储上的数据
1. DBMS存储了大量的数据，并且数据要在程序执行过程中保持持久性。因此数据要存储在外部存储设备上，并在需要处理的时候载入内存。
2. 在磁盘上读写信息的单位是页，页的大小是DBMS的一个参数，典型的值是4KB或8KB。
3. 页I/O的代价代表了典型的数据库操作的代价，因此需要十分小心地优化数据库系统来尽量减小这个代价。
4. 磁带是顺序访问设备，通常用于不常用数据的存档。
5. 文件中的每一个记录都有一个唯一的标示符，称为记录id，简称rid。一个rid有一个属性，可以用它来识别包含该记录的页在磁盘上的地址。
6. 为了处理，数据需要读入内存‘为了持久存储，数据需要写入磁盘。这些操作都是由称为缓冲区管理器的软件层来完成的。磁盘上的空间则由磁盘空间管理器来管理。

### 8.2 文件组织与索引
1. 一个关系通常存储为一个记录文件。
2. 文件层将文件中的记录存储于一组磁盘页。文件层跟踪分配给每一个文件的所有页，并且因为文件中的记录可能被插入或删除，它还跟踪分配给文件的页的可用空间。
3. 最简单的文件结构是无序文件，或称堆文件。一个堆文件中的数据在文件页中以任意的顺序排列。堆文件组织支持所有记录的检索，或者检索指定id的某一特定记录；文件管理器必须跟踪分配给文件的所有页面。
4. 索引是在磁盘上组织数据记录的一种数据结构，它用于优化某类数据检索的操作。可以在一个给定的数据记录集合上创建多个索引，每一个索引都有不同的搜索码，以支持那些不能被文件组织有效支持的搜索操作。
5. 我们使用术语**数据项**来指代存储在索引文件中的记录。搜索码值为k的数据项记为k*，包含有足够的信息以定位（一个或多个）搜索码值为k的数据记录。
6. 数据项的三种不同方式：
* （1）数据项k*是一个真正的数据记录
* （2）数据项是一个<k,rid>对，其中rid是搜索码值为k的数据记录的记录id
* （3）数据项是一个<k,rid-list>对，其中rid-list是搜索码值为k的数据记录的记录id的列表
7 第二和第三中方式包含指向数据记录的数据项，并独立于被索引文件的文件组织。

#### 8.2.1 聚簇索引
1. 如果一个文件组织成如下形式：数据记录的顺序与某一索引的数据项顺序相同或类似，我们就称这一索引是**聚簇索引**；否则，就是非聚簇索引。
2. 由定义可知，使用第一种方式的索引是聚簇的。使用第二种和第三种方式的索引只有当数据记录按照搜索码排序时才是聚簇索引，否则，如果数据记录是任意排列的，仅仅由它们的物理顺序来决定，那么将索引的数据项按照数据记录的顺序排列是没有意义的。
3. 有时候，我们称使用第一种方式的索引是聚簇文件，因为其数据项是真正的数据记录，因此该索引就是数据记录的文件。
4. **使用索引来回答范围搜索查询的代价是非常不同的，其代价依赖于索引是否是聚簇的。如果索引是聚簇的，例如，我们使用聚簇文件的搜索码，符合条件的数据项的rid应该是指向连续的记录，这样就只需要检索若干个数据页。如果索引是非聚簇的，每一个满足条件的数据项的rid可能指向不同的数据页，以至于数据页的I/O数与满足范围搜索条件的数据项的个数一样多。**（第13章进一步讨论）

#### 8.2.2 主索引和次索引
1. 建立在包含主码的字段集合上的索引称为主索引，其他的索引就被称为次索引。
2. 如果两个数据项有相同的索引搜索码，它们就称为重复。主索引可以保证不含有重复，但是在其他字段上的索引可能包含重复。
3. 如果我们知道一个索引没有重复，那么就可以知道其搜索码包含候选码，我们称这样的索引为唯一索引。

### 8.3 索引数据结构
组织数据项的方法之一是按照搜索码对数据项进行哈希。另一种方法是建立一个树状的数据结构，将搜索定位到数据项。哈希和树的索引技术可以与三种数据项方式的任一种组合使用。

#### 8.3.1 基于哈希的索引
1. 在该方法中，文件中的记录被分组存放在不同的桶中，其中一个桶由一个主页构成，或者是由一个主页和多个页构成的链组成。一个记录属于哪个桶可以由一个特殊的哈希函数用于搜索码来决定。给出一个桶号，一个基于哈希的索引结构允许我们进行一到两次磁盘I/O就能检索到该桶的主页。
2. 索引的搜索码可以是一个或多个字段的序列，它不必唯一的确定记录。主码或候选码唯一的标识一个记录，它们和搜索码的概念没有任何关系。

### 8.3.2 基于树的索引
